name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: "1.23"
  GO_MIN_VERSION: "1.21"

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ["1.21", "1.22", "1.23"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run tests
        run: |
          echo "Running tests with race detector..."
          go test -v -race -coverprofile=coverage.out ./... 2>&1 | tee test_output.log || {
            echo "=== Tests failed. Analyzing failures ==="
            echo "Full test output:"
            cat test_output.log | tail -100
            echo ""
            echo "=== Specific failures ==="
            grep -E "(FAIL|panic|fatal|error)" test_output.log | head -30 || echo "No specific failures found in output"
            echo ""
            echo "=== Running tests without race detector to isolate issue ==="
            go test -v ./... 2>&1 | tail -50 || true
            exit 1
          }
          echo "✓ All tests passed"
        continue-on-error: false

      - name: Upload coverage
        if: matrix.go-version == '1.22'
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-atlas-vm
          fail_ci_if_error: false
        continue-on-error: true

      - name: Run go vet
        run: go vet ./...

      - name: Check formatting
        run: |
          # Install gofumpt for stricter formatting
          go install mvdan.cc/gofumpt@latest
          # Check formatting
          if [ "$(gofumpt -l . | wc -l)" -gt 0 ]; then
            echo "The following files are not formatted:"
            gofumpt -l .
            exit 1
          fi

      - name: Run staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...
        continue-on-error: true

      - name: Run vulnerability check
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./... || echo "Vulnerability check found issues or encountered an error (non-blocking)"
        continue-on-error: true

      - name: Prepare reports directory
        run: mkdir -p reports

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m --config .golangci.yml
        continue-on-error: true

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: golangci-reports-${{ matrix.go-version }}
          path: reports/
          retention-days: 7
          if-no-files-found: ignore

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Build all binaries
        run: |
          mkdir -p bin
          if [ -d "./cmd" ]; then
            for cmd in ./cmd/*; do
              if [ -d "$cmd" ]; then
                cmd_name=$(basename "$cmd")
                echo "Building ${cmd_name}..."
                go build -v -ldflags="-s -w" -o "bin/${cmd_name}" "./cmd/${cmd_name}" || {
                  echo "Failed to build ${cmd_name}"
                  exit 1
                }
              fi
            done
            echo "✓ All binaries built successfully"
            ls -lh bin/
          else
            echo "No cmd directory found"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/
          retention-days: 7
          if-no-files-found: error

  examples:
    name: Test Examples
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run examples
        run: |
          echo "Testing examples..."
          if [ -d "./examples" ]; then
            for example in ./examples/*/main.go; do
              if [ -f "$example" ]; then
                example_dir=$(dirname "$example")
                example_name=$(basename "$example_dir")
                echo "Running example: $example_name..."
                cd "$example_dir" && timeout 30s go run main.go > /dev/null 2>&1 || true
                cd - > /dev/null
              fi
            done
            echo "✓ All examples executed"
          else
            echo "No examples found"
          fi

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run integration tests
        run: |
          if [ -d "./tests/integration" ]; then
            echo "Running integration tests..."
            go test -v -timeout=10m ./tests/integration/... || {
              echo "Integration tests failed. Checking for specific failures..."
              go test -v ./tests/integration/... 2>&1 | tail -50 || true
              exit 1
            }
            echo "✓ All integration tests passed"
          else
            echo "No integration tests found"
          fi

